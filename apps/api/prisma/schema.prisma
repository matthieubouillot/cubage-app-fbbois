generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// *
///  * ──────────────────────────────────────────────────────────────
///  * ENTREPRISES
///  * ───────────────────────────────────────────────────────────────
model Entreprise {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users     User[]
}

/// *
///  * ──────────────────────────────────────────────────────────────
///  * UTILISATEURS & ROLES
///  * ───────────────────────────────────────────────────────────────
model User {
  id                   String                @id @default(uuid())
  firstName            String
  lastName             String
  email                String                @unique
  phone                String
  password             String
  numStart             Int
  numEnd               Int
  createdAt            DateTime              @default(now())
  companyId            String?
  roles                Role[]
  company              Entreprise?           @relation(fields: [companyId], references: [id], onDelete: SetNull)
  assignments          Assignment[]
  debardeurAssignments DebardeurAssignment[]
  passwordResetTokens  PasswordResetToken[]
  debardeurSaisies     Saisie[]              @relation("SaisieDebardeur")
  saisies              Saisie[]

  @@index([companyId])
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([expiresAt])
}

/// *
///  * ──────────────────────────────────────────────────────────────
///  * CLIENTS
///  * ───────────────────────────────────────────────────────────────
model Client {
  id         String     @id @default(uuid())
  firstName  String
  lastName   String
  email      String     @unique
  phone      String
  street     String
  postalCode String
  city       String
  properties Property[]
  createdAt  DateTime   @default(now())
  chantiers  Chantier[]
}

/// *
///  * ──────────────────────────────────────────────────────────────
///  * PROPRIÉTÉS (terrains des clients)
///  * ───────────────────────────────────────────────────────────────
model Property {
  id               String     @id @default(uuid())
  commune          String?
  lieuDit          String?
  section          String?    @db.VarChar(2)
  parcelle         String?
  surfaceCadastrale Decimal?   @db.Decimal(10, 3)
  clientId         String
  chantiers        Chantier[]
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  client           Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}

/// *
///  * ──────────────────────────────────────────────────────────────
///  * ESSENCES
///  * ───────────────────────────────────────────────────────────────
model Essence {
  id            String                @id @default(uuid())
  name          String                @unique
  createdAt     DateTime              @default(now())
  qualityGroups QualityGroupEssence[]
}

/// *
///  * ──────────────────────────────────────────────────────────────
///  * QUALITÉS
///  * ───────────────────────────────────────────────────────────────
model Qualite {
  id            String         @id @default(uuid())
  name          String         @unique
  createdAt     DateTime       @default(now())
  qualityGroups QualityGroup[]
}

/// *
///  * ──────────────────────────────────────────────────────────────
///  * SCIEURS
///  * ───────────────────────────────────────────────────────────────
model Scieur {
  id            String         @id @default(uuid())
  name          String         @unique
  createdAt     DateTime       @default(now())
  qualityGroups QualityGroup[]
}

/// *
///  * ──────────────────────────────────────────────────────────────
///  * GROUPES QUALITÉ (Essence + Qualité + Scieur)
///  * ───────────────────────────────────────────────────────────────
model QualityGroup {
  id                String                 @id @default(uuid())
  name              String                 @unique(map: "QualityGroup_name_unique") @map("quality_group_name")
  category          String
  createdAt         DateTime               @default(now())
  qualiteId         String
  scieurId          String
  pourcentageEcorce Int
  chantierGroups    ChantierQualityGroup[]
  lotConventions    LotConvention?
  gpsPoints         GPSPoint[]
  qualite           Qualite                @relation(fields: [qualiteId], references: [id])
  scieur            Scieur                 @relation(fields: [scieurId], references: [id])
  essences          QualityGroupEssence[]
  saisies           Saisie[]
}

/// *
///  * ──────────────────────────────────────────────────────────────
///  * RELATION N↔N Essence ↔ QualityGroup
///  * ───────────────────────────────────────────────────────────────
model QualityGroupEssence {
  id             String       @id @default(uuid())
  essenceId      String
  qualityGroupId String
  essence        Essence      @relation(fields: [essenceId], references: [id])
  qualityGroup   QualityGroup @relation(fields: [qualityGroupId], references: [id])

  @@unique([essenceId, qualityGroupId])
}

/// *
///  * ──────────────────────────────────────────────────────────────
///  * LOTS & CONVENTIONS
///  * ───────────────────────────────────────────────────────────────
model LotConvention {
  id             String       @id @default(uuid())
  lot            String
  convention     String
  qualityGroupId String       @unique
  qualityGroup   QualityGroup @relation(fields: [qualityGroupId], references: [id])
}

/// *
///  * ──────────────────────────────────────────────────────────────
///  * CHANTIERS
///  * ───────────────────────────────────────────────────────────────
model Chantier {
  id                   String                 @id @default(uuid())
  numeroCoupe          String                 @unique
  section              String?                @db.VarChar(2)
  parcel               String?
  propertyId           String?
  createdAt            DateTime               @default(now())
  clientId             String?
  assignments          Assignment[]
  client               Client?                @relation(fields: [clientId], references: [id])
  property             Property?              @relation(fields: [propertyId], references: [id])
  qualityGroups        ChantierQualityGroup[]
  debardeurAssignments DebardeurAssignment[]
  gpsPoints            GPSPoint[]
  saisies              Saisie[]
  fiche                ChantierFiche?
  
  @@index([propertyId])
}

/// *
///  * ──────────────────────────────────────────────────────────────
///  * RELATION N↔N Chantier ↔ QualityGroup
///  * ───────────────────────────────────────────────────────────────
model ChantierQualityGroup {
  id             String       @id @default(uuid())
  chantierId     String
  qualityGroupId String
  chantier       Chantier     @relation(fields: [chantierId], references: [id])
  qualityGroup   QualityGroup @relation(fields: [qualityGroupId], references: [id])

  @@unique([chantierId, qualityGroupId])
}

/// *
///  * ──────────────────────────────────────────────────────────────
///  * ASSIGNATIONS UTILISATEURS
///  * ───────────────────────────────────────────────────────────────
model Assignment {
  id         String   @id @default(uuid())
  userId     String
  chantierId String
  chantier   Chantier @relation(fields: [chantierId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([userId, chantierId])
}

/// *
///  * ──────────────────────────────────────────────────────────────
///  * SAISIES (lignes LONG / DIAM + calculs)
///  * ───────────────────────────────────────────────────────────────
model Saisie {
  id             String       @id @default(uuid())
  chantierId     String
  qualityGroupId String
  userId         String
  date           DateTime     @default(now())
  numero         Int
  longueur       Decimal      @db.Decimal(10, 2)
  diametre       Decimal      @db.Decimal(10, 2)
  volumeCalc     Decimal      @db.Decimal(12, 4)
  volLtV1        Decimal?     @db.Decimal(12, 4)
  volBetweenV1V2 Decimal?     @db.Decimal(12, 4)
  volGeV2        Decimal?     @db.Decimal(12, 4)
  annotation     String?
  version        Int          @default(1)
  debardeurId    String?
  chantier       Chantier     @relation(fields: [chantierId], references: [id])
  debardeur      User?        @relation("SaisieDebardeur", fields: [debardeurId], references: [id])
  qualityGroup   QualityGroup @relation(fields: [qualityGroupId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@index([chantierId])
  @@index([userId])
  @@index([qualityGroupId])
  @@index([debardeurId])
}

/// *
///  * ──────────────────────────────────────────────────────────────
///  * POINTS GPS
///  * ───────────────────────────────────────────────────────────────
model GPSPoint {
  id             String       @id @default(uuid())
  latitude       Float
  longitude      Float
  name           String?
  notes          String?
  order          Int
  chantierId     String
  qualityGroupId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  chantier       Chantier     @relation(fields: [chantierId], references: [id], onDelete: Cascade)
  qualityGroup   QualityGroup @relation(fields: [qualityGroupId], references: [id], onDelete: Cascade)

  @@index([chantierId])
  @@index([qualityGroupId])
}

model DebardeurAssignment {
  id         String   @id @default(uuid())
  userId     String
  chantierId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  chantier   Chantier @relation(fields: [chantierId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, chantierId])
  @@index([chantierId])
}

/// *
///  * ──────────────────────────────────────────────────────────────
///  * FICHE CHANTIER (données saisies manuellement)
///  * ───────────────────────────────────────────────────────────────
model ChantierFiche {
  id              String   @id @default(uuid())
  chantierId      String   @unique
  aFacturerValues Json     // Record<string, { abattage: string; debardage: string }>
  fraisGestionValues Json  // Record<number, string>
  prixUHT         Json     // { aba: string; deb: string }
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  chantier        Chantier @relation(fields: [chantierId], references: [id], onDelete: Cascade)

  @@index([chantierId])
}

enum Role {
  SUPERVISEUR
  BUCHERON
  DEBARDEUR
}
